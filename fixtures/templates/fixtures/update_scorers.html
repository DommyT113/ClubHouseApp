<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Update Scorers</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 40px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #002d62; }
        .fixture-info { background-color: #f9f9f9; border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .search-section, .scorers-list { margin-bottom: 20px; }
        input[type="search"], input[type="text"], select { width: 95%; padding: 10px; font-size: 1em; border-radius: 4px; border: 1px solid #ccc; }
        #player-results { border: 1px solid #ccc; max-height: 200px; overflow-y: auto; margin-top: 5px; border-radius: 4px; }
        .player-result-item { padding: 10px; cursor: pointer; }
        .player-result-item:hover { background-color: #f0f0f0; }
        .scorer-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .scorer-name { font-weight: bold; flex-grow: 1; }
        .quantity-controls { display: flex; align-items: center; }
        .quantity-btn { background-color: #007bff; color: white; border: none; width: 30px; height: 30px; font-size: 1.2em; cursor: pointer; border-radius: 50%; margin: 0 10px; }
        .quantity-display { font-size: 1.2em; min-width: 20px; text-align: center; }
        .btn { background-color: #d9232d; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; }
        a { color: #002d62; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Update Scorers</h1>
        <div class="fixture-info">
            <strong>Match:</strong> {{ fixture.home_team.name }} vs {{ fixture.away_team.name }}<br>
            <strong>Date:</strong> {{ fixture.match_date }}
        </div>

        <div class="search-section">
            <h2>Add a Scorer</h2>
            <input type="search" id="player-search" placeholder="Search for a player...">
            <div id="player-results"></div>
        </div>

        <div class="scorers-list">
            <h2>Current Scorers</h2>
            <div id="scorers-container"></div>
        </div>

        <button class="btn" id="add-new-player-btn">Add New Player</button>
        <p style="margin-top: 20px;"><a href="{% url 'fixture_list' %}">&larr; Back to Fixtures</a></p>
    </div>

    <div id="add-player-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Add New Player</h2>
            <p>Couldn't find the player? Add them to the master list here.</p>
            <input type="text" id="new-player-name" placeholder="Full Name" style="margin-bottom: 10px;">
            <select id="new-player-gender" style="margin-bottom: 10px;">
                <option value="">Select Gender...</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
            </select>
            <button class="btn" id="save-new-player-btn">Save Player</button>
            <div id="modal-error" style="color: red; margin-top: 10px;"></div>
        </div>
    </div>

    {{ all_players_json|json_script:"all-players-data" }}
    {{ existing_goals_json|json_script:"existing-goals-data" }}

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        let allPlayers = JSON.parse(document.getElementById('all-players-data').textContent);
        const existingGoals = JSON.parse(document.getElementById('existing-goals-data').textContent);

        const searchInput = document.getElementById('player-search');
        const resultsContainer = document.getElementById('player-results');
        const scorersContainer = document.getElementById('scorers-container');
        const fixtureId = {{ fixture.id }};
        const csrfToken = document.querySelector('[name=csrf-token]').content;

        let currentScorers = {};

        function renderScorers() {
            scorersContainer.innerHTML = '';
            const sortedScorers = Object.keys(currentScorers).sort((a, b) => {
                const playerA = allPlayers.find(p => p.id == a);
                const playerB = allPlayers.find(p => p.id == b);
                if (!playerA || !playerB) return 0;
                return playerA.full_name.localeCompare(playerB.full_name);
            });

            for (const playerId of sortedScorers) {
                const player = allPlayers.find(p => p.id == playerId);
                if (player) {
                    const quantity = currentScorers[playerId];
                    const row = document.createElement('div');
                    row.className = 'scorer-row';
                    row.innerHTML = `
                        <div class="scorer-name">${player.full_name}</div>
                        <div class="quantity-controls">
                            <button class="quantity-btn minus-btn" data-player-id="${playerId}">-</button>
                            <div class="quantity-display">${quantity}</div>
                            <button class="quantity-btn plus-btn" data-player-id="${playerId}">+</button>
                        </div>
                    `;
                    scorersContainer.appendChild(row);
                }
            }
        }

        async function updateGoalCount(playerId, newQuantity) {
            if (newQuantity <= 0) {
                delete currentScorers[String(playerId)];
            } else {
                currentScorers[String(playerId)] = newQuantity;
            }
            await saveGoal(playerId, newQuantity);
            renderScorers();
        }

        async function saveGoal(playerId, quantity) {
            try {
                const response = await fetch(`/fixture/${fixtureId}/scorers/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ player_id: playerId, quantity: quantity })
                });
                if (!response.ok) console.error('Failed to save goal');
            } catch (error) { console.error('Error:', error); }
        }

        function addScorer(playerId) {
            if (!currentScorers[String(playerId)]) {
                updateGoalCount(playerId, 1);
            }
        }

        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            resultsContainer.innerHTML = '';
            if (query.length < 1) return;
            const filtered = allPlayers.filter(p => p.full_name.toLowerCase().includes(query) && !currentScorers[String(p.id)]);
            filtered.slice(0, 10).forEach(player => {
                const item = document.createElement('div');
                item.className = 'player-result-item';
                item.textContent = player.full_name;
                item.addEventListener('click', () => {
                    addScorer(player.id);
                    searchInput.value = '';
                    resultsContainer.innerHTML = '';
                });
                resultsContainer.appendChild(item);
            });
        });

        scorersContainer.addEventListener('click', (e) => {
            const playerId = e.target.dataset.playerId;
            if (!playerId) return;
            const currentQuantity = currentScorers[playerId] || 0;
            if (e.target.classList.contains('plus-btn')) {
                updateGoalCount(playerId, currentQuantity + 1);
            } else if (e.target.classList.contains('minus-btn')) {
                updateGoalCount(playerId, currentQuantity - 1);
            }
        });

        const modal = document.getElementById('add-player-modal');
        document.getElementById('add-new-player-btn').onclick = () => { modal.style.display = 'block'; };
        document.querySelector('.close-btn').onclick = () => { modal.style.display = 'none'; };
        window.onclick = (e) => { if (e.target == modal) { modal.style.display = 'none'; }};

        document.getElementById('save-new-player-btn').addEventListener('click', async () => {
            const newName = document.getElementById('new-player-name').value;
            const newGender = document.getElementById('new-player-gender').value;
            const modalError = document.getElementById('modal-error');
            modalError.textContent = '';

            try {
                const response = await fetch('/add_player/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ full_name: newName, gender: newGender })
                });
                const result = await response.json();
                if (response.ok) {
                    allPlayers.push(result.player);
                    allPlayers.sort((a, b) => a.full_name.localeCompare(b.full_name));
                    modal.style.display = 'none';
                    document.getElementById('new-player-name').value = '';
                    document.getElementById('new-player-gender').value = '';
                } else {
                    modalError.textContent = result.message || 'Failed to save player.';
                }
            } catch (error) { modalError.textContent = 'An error occurred.'; }
        });

        for (const playerId in existingGoals) {
            currentScorers[playerId] = existingGoals[playerId];
        }
        renderScorers();
    });
    </script>
</body>
</html>